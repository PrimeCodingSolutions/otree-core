{% extends "global/Page.html" %}
{% load otree static %}
{% load static %}
{% block styles %}
    <style>
        body {
            background-color: #901A1E;
        }
    </style>
{% endblock %}
{% block content %}
<div class="game-container container">
    <div class="round-introduction">
        <h2 class="round-title">{{ question.title }}</h2>
        <div class="round-info">
            <h3>SÃ¥dan spiller du</h3>
            <p>{{ question.text }}</p>
            <p>{{ question.challenge }}</p>
            <p>{{ question.preference }}</p>

        </div>
    </div>
<div class="surround">
<div class="game-row">
        <!-- Left hand side-->
    <div class="svg-column">
      <div class="answer-container" id="d3container">
        <div id="timer-text">
            Tid tilbage:
            <strong><span id="timer" class="otree-timer__time-left"></span></strong>
        </div>
        </div>

      <div id="ButtonsHolder" class="choice-button-holder">
        <button style="background-image: url({{ question.majority_color_img }})" id="GuessFalseButton" type="button" name="choice" value="False" class="btn choice-button">
           <b> {{ question.majority_choice }}</b>
        </button>

        <button style="background-image: url({{ question.minority_color_img  }})" id="GuessTrueButton" type="button" name="choice" value="True" class="btn choice-button">
           <b>{{ question.minority_choice }}</b>
        </button>
        </div>
    </div>


      <!-- Right hand side -->
    <div id="chat-container">
        <div class="chat-title">
            <h2>Chat med dine venner</h2>
        </div>

        <div class="form-group chat">
            <div id="chat" type="text-area"></div>
        </div>
        <div class="form-group message">
            <input type="text" id="message" placeholder="Send besked..." class="form-control">
        </div>
        <div class="form-group send">
            <button id="send" class="btn btn-success">Send</button>
        </div>
    </div>
</div>

</div>
</div>









    <script>
    // We want to randomise whether the button for the majority choice is on the left or the right
    // so that players can't catch on an tell which is the majority for the button position
    $('#ButtonsHolder').css('flex-direction', Math.random() > 0.5 ? 'row' : 'row-reverse');

        $('#timer').on('DOMSubtreeModified', function () {
            let element = $('#timer');

            if (!element.hasClass('flash')) {
                let split = element.text().split(':');
                let minutes = parseInt(split[0]);
                let seconds = parseInt(split[1]);

                if (minutes <= 0 && seconds <= 20) {
                    $('#timer-text').addClass('flash');
                    element.addClass('flash')
                }
            }
        })
    </script>

    <script>
        // Array container for the sent messages to be used in localstorage
        let messages = [];
        console.log("the type is a " + typeof localStorage.getItem('messages'));

        // Defines the scheme of the WebSocket to be either wss if the protocol is https
        // else it should be ws
        let ws_scheme = window.location.protocol === "https" ? "wss" : "ws";

        // Defines the WebSocket route to listen to
        let ws_path = ws_scheme + '://' + window.location.host + "/ws/chat/{{ group.pk }}";

        // Instantiates the WebSocket with the WebSocket route and scheme as argument
        let socket = new WebSocket(ws_path);

        // Defines the DOM element for the submit button
        const button = document.getElementById('send');

        // Function that adds the player id to each message
        const mapFriends = () => {
            let friends = {{ player.get_friends }};
            let players = [];

            friends.map(
                item => {
                    players.push(`player_${item}`)
                }
            );

            return players;
        };

        // Returns all the players friends in the network
        let players = mapFriends();

        // Variable used for displaying the right messages
        let network = [];

        // Opens the WebSocket connection and logs a message in the console when it opens
        socket.onopen = () => {
            console.log('WebSocket opened');
            console.log("{{ player.id }}");
            console.log("{{ player.id_in_group }}");
            /*
            const chat = document.getElementById('chat');
            let chat_messages = JSON.parse(localStorage.getItem('messages'));
            chat.innerHTML = chat_messages;
            */
        };

        // Closes the WebSocket connection and logs a message in the console when it closes
        socket.onclose = () => {
            console.log("WebSocket closed");
        };

        // Logs a error if the WebSocket gets a connection error in the console
        socket.onerror = event => {
            console.error("WebSocket error observed:", event);
        };

        // When a message is sent it is appended to the container with id of chat
        socket.onmessage = event => {
            let data = JSON.parse(event.data).message;
            let message = data.chat_message;
            let chat_id = data.player_id;
            let player_id = {{ player.id_in_group }};
            const chat = document.getElementById('chat');

            let divElement = document.createElement('div');
            let paragraphElement = document.createElement('p');
            let boldElement = document.createElement('b');
            divElement.appendChild(boldElement);
            divElement.appendChild(paragraphElement);

            divElement.setAttribute('class', 'chat-message');
            divElement.setAttribute('id', `player_${chat_id}`);

            if(chat_id === player_id) {
                boldElement.textContent = `Spiller ${chat_id} (Dig):`
            } else {
                boldElement.textContent = `Spiller ${chat_id}:`;
            }
            paragraphElement.textContent = message;
            chat.appendChild(divElement);
            displayFriends();

        };

        // Adds an event listener on the send button that submits the message
        // and sends it to the WebSocket inside a p tag with the Player id in the group
        // after the message is sent, the value of the input is reset.
        button.addEventListener("click", event => {
            event.preventDefault();

            let message = document.getElementById('message');



            if (message.value !== '') {
                socket.send(JSON.stringify({
                    'message': {
                        "chat_message": message.value,
                        "player_id": {{ player.id_in_group }}
                    }
                }));
            }

            message.value = '';

        });


        // Function that hides the messages outside of the players network
        const displayFriends = () => {

            let chat_class = document.getElementsByClassName('chat-message');

            for (let i = 0; i < chat_class.length; i++) {
                network.push(chat_class[i].getAttribute('id'));
            }

            for (let player in network) {
                if (players.includes(network[player])) {
                    document.getElementById(network[player]).style.display = 'flex';
                } else {
                    document.getElementById(network[player]).style.display = 'none';
                }
            }
        };

    </script>

{% endblock %}

{% block scripts %}
    {% include 'bad_influence/channels/network_voting_channel.html' %}
    {% include 'bad_influence/d3/d3_graph.html' %}
    {% if view.remaining_timeout_seconds != None %}
        {% include 'otree/includes/TimeLimit.js.html' %}
    {% endif %}
    {{ form.media|default:"" }}

{% endblock %}


