{% extends "global/Base.html" %}
{% load staticfiles otree %}

{% block title %}
    {{ player.company_name }}
{% endblock %}

{% block styles %}
    <style>
        body {
            background: #41739D;
        }

        ._otree-content {
            display: flex;
            justify-content: center;
        }

        #timer {
            display: flex;
            justify-content: center;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="daytrader-game-container">
        <div class="game-content">
            <div class="game-timer">
                <div class="game-timer-content">
                            <span>RUNDE {{ current_round }}: </span>
                    <br>
                          <span class="otree-timer__time-left"></span>


                </div>

            </div>
            <div class="header-block">
                <h2 class="company-title">
                    {{ player.company_name }}
                </h2>
                <div class="table-description">
                    <p>
                        Du er trader nummer <b>{{ player.round_number }}</b> og du skal nu handle aktier i firmaet
                        <br><b>'{{ player.company_name }}'</b>
                    </p>

                </div>
            </div>
        </div>
    </div>





{% endblock %}
{% block scripts %}
    <script>


        let containers = document.getElementsByClassName("faceContainer");
        let drawn_face = {{ player.drawn_face|yesno:"true,false" }};
        let states = document.getElementsByClassName("state-container");
        let buttonContainer = document.getElementsByClassName("btn-container");
        let group_ids = [];
        let current_group_id = {{ group.id }};
        let companyIds = document.getElementsByClassName("company-id");
        let data = {{ rounds|safe }};
        let sackContainer1 = document.querySelector("#sack-container-1");
        let sackContainer2 = document.querySelector("#sack-container-2");
        let sackContainer3 = document.querySelector("#sack-container-3");

        let containerSack = document.querySelector(".daytrader-sack-button-container");
        let sackButtons = document.getElementsByClassName("sack-btn");

        let radioButton = document.getElementsByClassName("form-check-input");
        let inputContainer = document.querySelector(".daytrader-submit-value");

        // Show the InputField, focus the input and select the input
        for (let button = 0; button < radioButton.length; button++) {
            try {
                radioButton[button].onclick = event => {
                inputContainer.style.display = "block";
                document.getElementById("myInput").focus();
                document.getElementById("myInput").select();
                }
            }
              catch(err) {
                console.log("ERROR: Unable to focus")
            }
        }




        function toggle(className, displayState) {
            let elements = document.getElementsByClassName(className);

            for (let i = 0; i < elements.length; i++) {
                elements[i].style.display = displayState;
            }

        }

        for (let i = 0; i < sackButtons.length; i++) {
            sackButtons.id = "button" + i;
            sackButtons[i].onclick = event => {
                event.preventDefault();
                let happyFace = document.createElement("img");
                happyFace.className = "company-face-in-sack";
                happyFace.src = "{% static 'daytrader/media/happy_face_daytrader.png' %}";
                let sadFace = document.createElement("img");
                sadFace.className = "company-face-in-sack";
                sadFace.src = "{% static 'daytrader/media/sad_face_daytrader.png' %}";
                let unknownFace1 = document.createElement("img");
                unknownFace1.className = "company-face-in-sack";
                unknownFace1.src = "{% static 'daytrader/media/unknown-face-green.png' %}";
                let unknownFace2 = document.createElement("img");
                unknownFace2.className = "company-face-in-sack";
                unknownFace2.src = "{% static 'daytrader/media/unknown-face-green.png' %}";

                let existingGroups = JSON.parse(localStorage.getItem("all_groups"));
                if (existingGroups === null) existingGroups = [];
                localStorage.setItem("current_group", JSON.stringify(current_group_id));
                existingGroups.push(current_group_id);
                localStorage.setItem("all_groups", JSON.stringify(existingGroups));
                localStorage.setItem("clicked", "true");

                let selectedClick = {
                    name: "{{ player.company_name }}",
                    group_id: {{ group.id }},
                    button_click: sackButtons[i].parentElement.getAttribute("id")
                };


                let existingSelections = JSON.parse(localStorage.getItem("all_selections"));
                if (existingSelections === null) existingSelections = [];
                localStorage.setItem("selected_click", JSON.stringify(selectedClick));
                existingSelections.push(selectedClick);
                localStorage.setItem("all_selections", JSON.stringify(existingSelections));

                if (sackButtons[i].parentElement.getAttribute("id") === "sack-container-1") {
                    toggle("sack-btn", "none");
                    if (drawn_face === true) {
                        sackContainer1.appendChild(happyFace);
                        sackContainer2.appendChild(unknownFace2);
                        sackContainer3.appendChild(unknownFace1);
                    } else if (drawn_face === false) {
                        sackContainer1.appendChild(sadFace);
                        sackContainer2.appendChild(unknownFace2);
                        sackContainer3.appendChild(unknownFace1);
                    }
                }

                if (sackButtons[i].parentElement.getAttribute("id") === "sack-container-2") {
                    toggle("sack-btn", "none");
                    if (drawn_face === true) {
                        sackContainer1.appendChild(unknownFace2);
                        sackContainer2.appendChild(happyFace);
                        sackContainer3.appendChild(unknownFace1);
                    } else if (drawn_face === false) {
                        sackContainer1.appendChild(unknownFace2);
                        sackContainer2.appendChild(sadFace);
                        sackContainer3.appendChild(unknownFace1);
                    }
                }

                if (sackButtons[i].parentElement.getAttribute("id") === "sack-container-3") {
                    toggle("sack-btn", "none");
                    if (drawn_face === true) {
                        sackContainer1.appendChild(unknownFace1);
                        sackContainer2.appendChild(unknownFace2);
                        sackContainer3.appendChild(happyFace);
                    } else if (drawn_face === false) {
                        sackContainer1.appendChild(unknownFace1);
                        sackContainer2.appendChild(unknownFace2);
                        sackContainer3.appendChild(sadFace);
                    }
                }


            }
        }

        let selection = JSON.parse(localStorage.getItem("selected_click"));
        if (selection.name === "{{ player.company_name }}" && selection.group_id === {{ group.id }}) {
            try {
                toggle("sack-btn", "none");
                let happyFace = document.createElement("img");
                happyFace.className = "company-face-in-sack";
                happyFace.src = "{% static 'daytrader/media/happy_face_daytrader.png' %}";
                let sadFace = document.createElement("img");
                sadFace.className = "company-face-in-sack";
                sadFace.src = "{% static 'daytrader/media/sad_face_daytrader.png' %}";
                let unknownFace1 = document.createElement("img");
                unknownFace1.className = "company-face-in-sack";
                unknownFace1.src = "{% static 'daytrader/media/unknown-face-green.png' %}";
                let unknownFace2 = document.createElement("img");
                unknownFace2.className = "company-face-in-sack";
                unknownFace2.src = "{% static 'daytrader/media/unknown-face-green.png' %}";
            }
             catch(err) {
                console.log("Selection-name is null")
            }



            if (selection.button_click === "sack-container-1") {
                toggle("sack-btn", "none");
                if (drawn_face === true) {
                    sackContainer1.appendChild(happyFace);
                    sackContainer2.appendChild(unknownFace2);
                    sackContainer3.appendChild(unknownFace1);
                } else if (drawn_face === false) {
                    sackContainer1.appendChild(sadFace);
                    sackContainer2.appendChild(unknownFace2);
                    sackContainer3.appendChild(unknownFace1);
                }
            }

            if (selection.button_click === "sack-container-2") {
                toggle("sack-btn", "none");
                if (drawn_face === true) {
                    sackContainer1.appendChild(unknownFace2);
                    sackContainer2.appendChild(happyFace);
                    sackContainer3.appendChild(unknownFace1);
                } else if (drawn_face === false) {
                    sackContainer1.appendChild(unknownFace2);
                    sackContainer2.appendChild(sadFace);
                    sackContainer3.appendChild(unknownFace1);
                }
            }

            if (selection.button_click === "sack-container-3") {
                toggle("sack-btn", "none");
                if (drawn_face === true) {
                    sackContainer1.appendChild(unknownFace1);
                    sackContainer2.appendChild(unknownFace2);
                    sackContainer3.appendChild(happyFace);
                } else if (drawn_face === false) {
                    sackContainer1.appendChild(unknownFace1);
                    sackContainer2.appendChild(unknownFace2);
                    sackContainer3.appendChild(sadFace);
                }
            }
        }




    </script>
{% endblock %}