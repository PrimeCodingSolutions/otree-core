{% extends "global/Base.html" %}
{% load staticfiles otree %}

{% block title %}
    {{ player.company_name }}
{% endblock %}

{% block styles %}
    <style>
        body {
            background: #41739D;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="game-container container">
        <div id="timer-text" class="container justify-content-md-start">
            Tid tilbage:
            <strong><span id="timer" class="otree-timer__time-left"></span></strong>
        </div>
        <div class="round-introduction">
            <h2 class="round-title">{{ player.company_name }}</h2>
        </div>
        {% if subsession.round_number > 1 %}
            <div class="container daytrader-round-info">
            <p class="daytrader-round-info">
                Nu er du trader nummer {{ player.round_number }} og du skal nu handle aktier i firmaet
                '{{ player.company_name }}'. Du kigger i sækken, og ser et ansigt der er
                {% if player.drawn_face is True %}
                    <img src="{% static 'daytrader/media/daytrader_happyface.png' %}" alt="happy face"
                         class="company-face">
                {% else %}
                    <img src="{% static 'daytrader/media/daytrader_sadface.png' %}" alt="sad face" class="company-face">
                {% endif %}
            </p>
        {% else %}
            <p class="daytrader-round-info">
                Du er den første trader, og du skal nu handle aktier i firmaet '{{ player.company_name }}'. Du kigger i
                sækken, og ser et ansigt der er
                {% if player.drawn_face is True %}
                    <img src="{% static 'daytrader/media/daytrader_happyface.png' %}" alt="happy face"
                         class="company-face">
                {% else %}
                    <img src="{% static 'daytrader/media/daytrader_sadface.png' %}" alt="sad face" class="company-face">
                {% endif %}
            </p>
        {% endif %}



        <div class="daytrader-info-choice">
            <div class="daytrader-round-info">
                Du har {{ player.wallet|c }} og aktieprisen er lige nu {{ player.price|c }}. Hvad vil du gøre?
            </div>
        </div>


        <table class="table daytrader-table">
            <tr class="table-corners">
                <th class="daytrader-table-header border-corner-left">trader</th>
                <th class="daytrader-table-header">pris</th>
                <th class="daytrader-table-header">ansigt</th>
                <th class="daytrader-table-header border-corner-right">handel</th>
            </tr>
            {% for r, price, choice, deals, states in data %}
                <tr>
                    <td class="company-id daytrader-table-data"> {{ r }}.</td>
                    <td class="daytrader-table-data"> {{ price|c }}</td>
                    <td class="faceContainer daytrader-table-data">
                        <div class="btn-container"></div>
                        {% if states is True %}
                            <div class="state-container">
                                <img src="{% static 'daytrader/media/daytrader_happyface.png' %}" alt="happy face"
                                     class="company-face">
                            </div>
                        {% else %}
                            <div class="state-container">
                                <img src="{% static 'daytrader/media/daytrader_sadface.png' %}" alt="sad face"
                                     class="company-face">
                            </div>
                        {% endif %}
                    </td>
                    <td class="daytrader-table-data"> {% if choice == True %} + {% else %} - {% endif %}
                        {{ deals }} aktier
                    </td>
                </tr>
            {% endfor %}
        </table>

        <div class="daytrader-form-container">
            {% formfield player.choice_of_trade label=None %}
            <p class="daytrader-form-info"> Hvor mange aktier? (du kan handle med maksimalt {{ player.can_buy }}
                aktier)</p>
            <div class="daytrader-submit-value">
                <div class="daytrader-formfield">
                    {% formfield player.choice_of_number_of_shares label=None %}
                </div>
                <div class="daytrader-next-btn">
                    {% next_button %}
                </div>
            </div>
        </div>
        </div>
    </div>






{% endblock %}
{% block scripts %}
    <script>


        let containers = document.getElementsByClassName("faceContainer");
        let drawn_face = {{ player.drawn_face|yesno:"true,false" }};
        let states = document.getElementsByClassName("state-container");
        let buttonContainer = document.getElementsByClassName("btn-container");
        let group_ids = []
        let current_group_id = {{ group.id }};
        let companyIds = document.getElementsByClassName("company-id");
        let nextBtn = document.querySelector(".otree-btn-next");

        {#if (!localStorage.getItem("all_groups").includes(current_group_id)) {#}
        {#    localStorage.removeItem("clicked");#}
        {##}

        nextBtn.textContent = "Køb/Sælg";


        function toggle(className, displayState) {
            let elements = document.getElementsByClassName(className);

            for (let i = 0; i < elements.length; i++) {
                elements[i].style.display = displayState;
            }
        }


        for (let i = 0; i < containers.length; i++) {
            toggle("state-container", "none");
            let unknownFace = document.createElement("img");
            unknownFace.className = "reveal-face";
            unknownFace.src = "{% static 'daytrader/media/unknown_face.png' %}";
            unknownFace.style.width = "40px";
            unknownFace.style.height = "40px";
            containers[i].appendChild(unknownFace);
        }


        let button = document.getElementsByClassName("reveal-face");

        for (let item = 0; item < button.length; item++) {

            button[item].onclick = event => {
                event.preventDefault();
                toggle("reveal-face", "none");
                states[item].style.display = "block";

                {#let existingGroups = JSON.parse(localStorage.getItem("all_groups"));#}
                {#if (existingGroups === null) existingGroups = [];#}
                {#localStorage.setItem("current_group", JSON.stringify(current_group_id));#}
                {#existingGroups.push(current_group_id);#}
                {#localStorage.setItem("all_groups", JSON.stringify(existingGroups));#}
                {##}
                {#localStorage.setItem("clicked", "true");#}

                let selectedClick = {
                    id: companyIds[item].textContent,
                    value: states[item].textContent,
                    name: "{{ player.company_name }}",
                    group_id: {{ group.id }}
                }


                let existingSelections = JSON.parse(localStorage.getItem("all_selections"));
                if (existingSelections === null) existingSelections = [];
                localStorage.setItem("selected_click", JSON.stringify(selectedClick));
                existingSelections.push(selectedClick);
                localStorage.setItem("all_selections", JSON.stringify(existingSelections));
            }
        }

        let selection = JSON.parse(localStorage.getItem("selected_click"));
        for (let i = 0; i < companyIds.length; i++) {
            if (selection.id === companyIds[i].textContent && selection.name === "{{ player.company_name }}" && selection.group_id === {{ group.id }}) {
                states[i].style.display = "block";
                toggle("reveal-face", "none");
            }
        }
    </script>
{% endblock %}