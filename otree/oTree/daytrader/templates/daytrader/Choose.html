{% extends "global/Base.html" %}
{% load staticfiles otree %}

{% block title %}
    {{ player.company_name }}
{% endblock %}

{% block styles %}
    <style>
        body {
            background: #41739D;
        }

        ._otree-content {
            display: flex;
            justify-content: center;
        }

        #timer {
            display: flex;
            justify-content: center;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="daytrader-game-container">
        <div class="content-container">

            <div class="round-introduction">
                <h2 class="daytrader-round-title">{{ player.company_name }}</h2>
            </div>

            <div class="daytrader-sack-button-container">
                <div class="daytrader-sack-buttons">

                    <table>
                        <tr>
                            <td></td>
                            <td><img src="{% static 'daytrader/media/unknown_face_daytrader.png' %}" alt="unknown face"
                                     class="sack-btn"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><img src="{% static 'daytrader/media/unknown_face_daytrader.png' %}"
                                     alt="unknown face" class="sack-btn"></td>
                            <td></td>
                            <td><img src="{% static 'daytrader/media/unknown_face_daytrader.png' %}"
                                     alt="unknown face" class="sack-btn"></td>
                        </tr>
                    </table>
                </div>
            </div>

            {% if subsession.round_number > 1 %}
                <div class="daytrader-round-info">
                <p class="daytrader-round-info">
                    Nu er du trader nummer {{ player.round_number }} og du skal nu handle aktier i firmaet
                    '{{ player.company_name }}'. </p>
            {% else %}
                <p class="daytrader-round-info">
                    Du er den første trader, og du skal nu handle aktier i firmaet
                    '{{ player.company_name }}'. </p>
            {% endif %}


            <div class="daytrader-info-choice">
                <div class="daytrader-round-info">
                    Du har {{ player.wallet|c }} og aktieprisen er lige nu {{ player.price|c }}. <br> Hvad vil du
                    gøre?
                </div>
            </div>


            {% if subsession.round_number > 1 %}

                <table class="table daytrader-table">
                    <tr class="table-corners">
                        <th class="daytrader-table-header border-corner-left">trader</th>
                        <th class="daytrader-table-header">pris</th>
                        <th class="daytrader-table-header">privat info</th>
                        <th class="daytrader-table-header border-corner-right">handel</th>
                    </tr>
                    {% for r, price, choice, deals, states in data %}
                        <tr class="daytrader-table-row">
                            <td class="company-id daytrader-table-data"> {{ r }}.</td>
                            <td class="daytrader-table-data"> {{ price|c }}</td>
                            <td class="daytrader-table-data">
                                <img src="{% static 'daytrader/media/unknown_face_daytrader.png' %}" alt="unknown face"
                                class="reveal-face">
                            </td>
                            <td class="daytrader-table-data"> {% if choice == True %} + {% else %} - {% endif %}
                                {{ deals }} aktier
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}
            <div id="timer-text" class="container justify-content-md-center">
                Tid tilbage:
                <strong><span id="timer" class="otree-timer__time-left"></span></strong>
            </div>

            <div class="daytrader-form-container">
                {% formfield player.choice_of_trade label=None %}

                <div class="daytrader-submit-value">
                    <p class="daytrader-form-info"> Hvor mange aktier? (du kan handle med maksimalt {{ player.can_buy }}
                        aktier)</p>
                    <div class="daytrader-formfield">
                        {% formfield player.choice_of_number_of_shares label=None %}
                    </div>
                    <div class="daytrader-next-btn-container">
                        <button class="daytrader-next-btn">
                            Køb/Sælg
                        </button>
                    </div>
                </div>
            </div>

            </div>
        </div>
    </div>






{% endblock %}
{% block scripts %}
    <script>


        let containers = document.getElementsByClassName("faceContainer");
        let drawn_face = {{ player.drawn_face|yesno:"true,false" }};
        let states = document.getElementsByClassName("state-container");
        let buttonContainer = document.getElementsByClassName("btn-container");
        let group_ids = []
        let current_group_id = {{ group.id }};
        let companyIds = document.getElementsByClassName("company-id");
        let data = {{ rounds|safe }};

        let containerSack = document.querySelector(".daytrader-sack-button-container");
        let sackButtons = document.getElementsByClassName("sack-btn");

        let radioButton = document.getElementsByClassName("form-check-input");
        let inputContainer = document.querySelector(".daytrader-submit-value");

        for (let button = 0; button < radioButton.length; button++) {
            radioButton[button].onclick = event => {
                inputContainer.style.display = "block";
            }
        }

        if (!localStorage.getItem("all_groups").includes(current_group_id)) {
            localStorage.removeItem("clicked");
        }

        let selection = JSON.parse(localStorage.getItem("selected_click"));
        console.log(selection.name);
        console.log("{{ player.company_name }}");
        if (selection.name === "{{ player.company_name }}" && selection.group_id === {{ group.id }}) {
            toggle("sack-btn", "none");
            let happyFace = document.createElement("img");
            happyFace.className = "company-face-in-sack";
            happyFace.src = "{% static 'daytrader/media/happy_face_daytrader.png' %}";
            let sadFace = document.createElement("img");
            sadFace.className = "company-face-in-sack";
            sadFace.src = "{% static 'daytrader/media/sad_face_daytrader.png' %}";

            if (drawn_face === true) {
                containerSack.appendChild(happyFace);
            }
            if (drawn_face === false) {
                containerSack.appendChild(sadFace);
            }
        }

        function toggle(className, displayState) {
            let elements = document.getElementsByClassName(className);

            for (let i = 0; i < elements.length; i++) {
                elements[i].style.display = displayState;
            }
        }

        for (let i = 0; i < sackButtons.length; i++) {

            sackButtons[i].onclick = event => {
                event.preventDefault();
                toggle("sack-btn", "none");
                let happyFace = document.createElement("img");
                happyFace.className = "company-face-in-sack";
                happyFace.src = "{% static 'daytrader/media/happy_face_daytrader.png' %}";
                let sadFace = document.createElement("img");
                sadFace.className = "company-face-in-sack";
                sadFace.src = "{% static 'daytrader/media/sad_face_daytrader.png' %}";

                if (drawn_face === true) {
                    containerSack.appendChild(happyFace);
                }
                if (drawn_face === false) {
                    containerSack.appendChild(sadFace);
                }

                let existingGroups = JSON.parse(localStorage.getItem("all_groups"));
                if (existingGroups === null) existingGroups = [];
                localStorage.setItem("current_group", JSON.stringify(current_group_id));
                existingGroups.push(current_group_id);
                localStorage.setItem("all_groups", JSON.stringify(existingGroups));
                localStorage.setItem("clicked", "true");

                let selectedClick = {
                    name: "{{ player.company_name }}",
                    group_id: {{ group.id }}
                }


                let existingSelections = JSON.parse(localStorage.getItem("all_selections"));
                if (existingSelections === null) existingSelections = [];
                localStorage.setItem("selected_click", JSON.stringify(selectedClick));
                existingSelections.push(selectedClick);
                localStorage.setItem("all_selections", JSON.stringify(existingSelections));
            }

        }


    </script>
{% endblock %}